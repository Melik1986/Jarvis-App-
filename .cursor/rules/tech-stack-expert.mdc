---
description: Экспертные практики по стеку JSRVIS из ТЗ — TypeScript, Nest.js, Expo, Tamagui, Zustand, Vercel AI SDK, Supabase, Qdrant, expo-av, react-native-gifted-chat, OData/1C.
globs: ["**/*.ts", "**/*.tsx", "**/app.json", "**/package.json"]
alwaysApply: false
---

# Экспертный стек JSRVIS (из ТЗ)

Источник: `attached_assets/(ТЗ)_JSRVIS_1C_Mobile_1769190888988.md`, `project/project.md`. При работе с перечисленными языками и библиотеками следовать этим практикам.

## TypeScript

- Strict mode; сквозная типизация между `apps/mobile`, `apps/server`, `shared/types`.
- Общие интерфейсы документов и товаров — в `shared/types`. Не дублировать типы между приложениями.
- Запрет `any`; явные типы для API-контрактов (request/response).

## Nest.js (server)

- Структура: `src/ai` (OpenAI, Qdrant), `src/ones` (1C), `src/auth` (Supabase Guard), `main.ts`.
- Эндпоинт чата: `POST /api/chat`, приём `messages`; ответ — стриминг или JSON в зависимости от клиента.
- Function Calling: маппинг намерений GPT в вызовы 1С; начать с функции `get_stock`; инструменты генерировать из OpenAPI/Swagger при универсальном ERP-коннекторе.
- Auth: Supabase Guard для проверки JWT/сессии перед защищёнными маршрутами.
- Переменные: `OPENAI`, `SUPABASE`, `QDRANT`, `ONE_C_URL` — из env, не хардкод.

## Expo / React Native (mobile)

- Структура: `src/components` (Chat, VoiceButton, CameraScanner), `src/hooks` (useJarvis, use1C, useVoice), `src/store` (Zustand), `src/services` (API wrappers).
- Конфиг: `app.json` (Expo). Тестирование на устройстве через Expo Go.
- Язык: TypeScript; импорт общих типов из `shared/types`.

## Tamagui

- UI: `YStack`, `Button`, `Text` и др. из `tamagui`; тема через конфиг (tokens: `$background` и т.д.).
- Оборачивать экраны в `YStack f={1} backgroundColor="$background"` при необходимости.
- Не смешивать с inline-стилями; использовать токены темы.

## react-native-gifted-chat

- Состояние сообщений: `useState` для массива; `GiftedChat.append` для добавления.
- `onSend`: добавить сообщение пользователя в state, отправить на бэкенд `POST /api/chat`, по ответу создать сообщение от бота и добавить через `append`.
- `user`: объект с `_id`, при необходимости `name` (например `Jarvis` для бота).
- Интеграция с бэкендом: `fetch` на Nest.js; при стриминге — Vercel AI SDK на клиенте или SSE.

## expo-av

- Запись голоса: запрос разрешений перед стартом записи; создание записи, сохранение в файл/URI.
- Отправка на бэкенд: загрузка файла/URI в эндпоинт транскрипции (Whisper); затем текст — в пайплайн чата/команд.
- Обработка ошибок: нет разрешения, сбой записи, сеть.

## Zustand + Persist

- Сторы: `authStore`, `inventoryStore` (остатки для offline-first).
- Persist: настройка для выбранного стора (остатки), чтобы данные были доступны офлайн.
- Не хранить секреты в сторе; только токены/сессия по необходимости и с учётом безопасности.

## Vercel AI SDK

- Стриминг ответов LLM для UX: ответ от Джарвиса появляется постепенно (слово за словом).
- На клиенте: `useChat` из `ai/react` при прямом вызове OpenAI-совместимого API; при своём бэкенде — передавать stream из Nest.js (SSE) и парсить на клиенте.
- BYO-LLM: подмена `baseURL` в конфиге SDK под Ollama/Groq/OpenRouter.

## Supabase

- Авторизация: Phone OTP (Supabase Auth). Настройка в проекте Supabase (Auth + Database).
- На клиенте: вызов метода входа по OTP; сохранение сессии; передача JWT в заголовках запросов к Nest.js.
- Guard на бэкенде: проверка JWT через Supabase client или JWT verify.

## Qdrant

- Коллекция: `kb_jarvis` (Qdrant Cloud или self-hosted).
- RAG «Библиотекарь»: эмбеддинги инструкций/регламентов; поиск по запросу пользователя; подстановка найденных фрагментов в контекст LLM.
- Размерность и модель эмбеддингов — единые для индекса и запросов.

## OpenAI / Whisper / GPT-4o-mini

- Whisper: транскрипция аудио с мобильного (expo-av) — отправка файла на бэкенд, вызов Whisper API.
- GPT-4o-mini: Vision для фото накладных/ценников; чат и Function Calling для интентов к 1С.
- Ключ в env (`OPENAI`); не в коде.

## 1C (OData/HTTP)

- Туннель к локальной 1С при разработке: Cloudflare или ngrok.
- Nest.js: модуль `ones` — формирование OData/HTTP-запросов по намерению от GPT (Function Calling); авторизация к 1С через настройки/учётные данные из конфига.
- Типы ответов 1С — по возможности описать в `shared/types`.

## Чеклист (из ТЗ)

- Инфраструктура: Expo, Nest.js + bun, Supabase, Qdrant.
- Ядро: `/api/chat`, Function Calling (`get_stock`), туннель к 1С.
- Мобильный UI: Tamagui, react-native-gifted-chat, expo-av.
- Финиш: загрузка фото + GPT-4o-mini Vision, поиск в Qdrant, тест на устройстве.
